---
title:  "CHIKV 28dpi scRNA-seq"
author: "Ryan Sheridan"
date:   "`r Sys.Date()`"
output: 
  html_document:
    toc:       true
    toc_float: true
    toc_depth: 3
    theme:     cosmo
    highlight: kate
params:
  
  unenr_dir:    "results/2021-11-05"      # Directory for unenriched data
  enr_dir:      "results/2022-02-03"      # Directory for CHIKV-enriched data
  template_dir: "src"                     # Directory for Rmd templates
  ref_dir:      "ref"
  table_dir:    "results/tables"          # Directory to write tables
  geo_dir:      "results/geo"             # Directory for GEO submission
  overwrite:    false                     # Should tables be overwritten if they already exist?
  so_dir:       "~/Dropbox/Ryan/Projects/morrison-chronic-chikv/results/sobjs/2024-01-14" # Directory for Seurat objects
  metrics:     "count_metrics.csv"       # Cell Ranger metrics
  gene_min:    250                       # Min number of detected genes per cell
  gene_max:    5500                      # Max number of detected genes per cell
  mito_max:    30                        # Max percentage mito reads per cells
  rm_doublets: true                      # Remove doublets
  type_res:    5                         # Resolution for annotating cell types
  mac_res:     2                         # Resolution for annotating macrophages
  t_res:       1                         # Resolution for annotating T cells
  fib_res:     5                         # Resolution for annotating fibroblasts cells
  tm:          "28dpi"                   # Label for time point
  rslns:
    value:
      type: 5
      mac:  2
      t:    1
      fib:  5
  samples:
    - "U1"
    - "U2"
    - "U3"
    - "C1"
    - "C2"
    - "C3"
editor_options: 
  chunk_output_type: console
---

<br>

```{r "setup", include = FALSE}
# Default chunk options
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo    = FALSE,
  dpi     = 300
)

knitr::knit(here::here("src/setup.Rmd"), output = "")
```

```{r "functions"}
plot_examples <- function(so_in, gns, split = NULL, thm = NULL,
                          clrs = c("#56B4E9", "white", "red")) {
  gns %>%
    map(~ {
      res <- so_in %>%
        FetchData(c("UMAP_1", "UMAP_2", split, .x)) %>%
        arrange(!!sym(.x)) %>%
        
        ggplot(aes(UMAP_1, UMAP_2, fill = !!sym(.x))) +
        geom_point_trace(size = 0.7, stroke = 0.5) +
        scale_fill_gradientn(colours = clrs) +
        guides(fill = guide_colorbar(ticks = FALSE, barheight = unit(150, "pt"))) +
        ggtitle(.x)
      
      if (!is.null(thm)) res <- res + thm
      
      if (!is.null(split)) {
        res <- res +
          facet_wrap(as.formula(str_c("~ ", split)))
      }
      
      res +
        theme(
          plot.title      = element_text(hjust = 0.5, size = 24),
          legend.position = "right"
        )
    })
}

#' Fetch genes for the provided annotations
fetch_genes <- function(terms, mart) {
  att  <- c("ensembl_gene_id", "external_gene_name")
  names(terms) <- names(terms) %||% rep("go_parent_name", length(terms))
  names(terms)[names(terms) == ""] <- "go_parent_name"
  
  res <- terms %>%
    imap(~ {
      getBM(
        attributes = att,
        filters    = .y,
        values     = .x,
        mart       = mart
      ) %>%
        pull(external_gene_name)
    }) %>%
    reduce(c) %>%
    unique()
  
  res
}
```

```{r "mac DEGs"}
# all macroaphges mock vs CHIKV
# for GSEA include all genes regardless of significance
Idents(so_mac) <- so_mac$treatment

chikv_deg_file <- here(dirs$table_dir, "mac_all_chikv_degs.tsv")

if (!file.exists(chikv_deg_file)) {
  all_mac_degs <- so_mac %>%
    FindConservedMarkers(
      ident.1         = "CHIKV",
      ident.2         = "mock",
      grouping.var    = "rep",
      logfc.threshold = 0
    ) %>%
    as_tibble(rownames = "gene")
  
  fc_clmns <- grep("_avg_log2FC$", colnames(all_mac_degs), value = TRUE)
  
  # Select lowest abs FC for all reps
  # maintain directionality since this is important for GSEA analysis
  all_mac_degs <- all_mac_degs %>%
    rowwise() %>%
    mutate(
      min_fc = min(abs(c(!!!syms(fc_clmns)))),
      min_fc = c(!!!syms(fc_clmns))[abs(c(!!!syms(fc_clmns))) == min_fc]
    ) %>%
    ungroup() %>%
    arrange(desc(min_fc))
  
  all_mac_degs %>%
    write_tsv(chikv_deg_file)
}

all_mac_degs <- read_tsv(chikv_deg_file)



# # CHIKV+ clusters DEGS
# # For GSEA save list that includes fold changes for all genes regardless of
# # significance
# Idents(so_mac) <- so$chikv_clst_grp
# 
# clst_deg_file <- here(dirs$table_dir, "mac_chikv-high_degs.tsv")
# 
# if (!file.exists(clst_deg_file)) {
#   clst_degs <- so_mac %>%
#     subset(treatment == treats[2]) %>%
#     FindConservedMarkers(
#       ident.1 = chikv_grps[2],
#       grouping.var = "rep",
#       logfc.threshold = 0.1
#     ) %>%
#     as_tibble(rownames = "gene")
#   
#   fc_clmns <- grep("_avg_log2FC$", colnames(clst_degs), value = TRUE)
#   
#   clst_degs <- clst_degs %>%
#     rowwise() %>%
#     mutate(
#       min_FC = min(abs(c(!!!syms(fc_clmns)))),
#       min_FC = c(!!!syms(fc_clmns))[abs(c(!!!syms(fc_clmns))) == min_FC]
#     ) %>%
#     ungroup() %>%
#     arrange(desc(min_FC))
#   
#   clst_degs %>%
#     write_tsv(clst_deg_file)
#   
# } else {
#   clst_degs <- read_tsv(clst_deg_file)
# }
```

```{r "mac subset DEGs"}
# all macroaphges mock vs CHIKV
Idents(so_mac) <- so_mac$treatment

chikv_deg_file <- here(dirs$table_dir, "mac_subset_chikv_degs.tsv")

# Identify DEGs
# include genes with max p-value < 0.05 for reps and abs log2 fold change > 0.25
if (!file.exists(chikv_deg_file)) {
  mac_degs <- unique(so_mac$mac_type) %>%
    map_dfr(~ {
      dat <- so_mac %>%
        subset(mac_type == .x)
      
      Idents(dat) <- dat$treatment
      
      dat %>%
        FindConservedMarkers(
          ident.1      = "CHIKV",
          ident.2      = "mock",
          grouping.var = "rep"
        ) %>%
        as_tibble(rownames = "gene") %>%
        mutate(cell_type = .x)
    })
  
  fc_clmns <- grep("_log2FC", colnames(mac_degs), value = TRUE)
    
  mac_degs <- mac_degs %>%
    rowwise() %>%
    mutate(
      min_fc         = min(abs(c(!!!syms(fc_clmns)))),
      min_fc         = c(!!!syms(fc_clmns))[abs(c(!!!syms(fc_clmns))) == min_fc],
      same_direction = all(c(!!!syms(fc_clmns)) > 0) || all(c(!!!syms(fc_clmns)) < 0),
      direction      = ifelse(min_fc > 0, "up", "down")
    ) %>%
    ungroup() %>%
    filter(
      max_pval    < 0.05,
      abs(min_fc) > 0.25,
      same_direction
    ) %>%
    arrange(cell_type, desc(min_fc))
  
  mac_degs %>%
    write_tsv(chikv_deg_file)
}

mac_degs <- chikv_deg_file %>%
  read_tsv() %>%
  mutate(direction = fct_relevel(direction, c("up", "down")))
```

```{r "mac GSEA"}
# all macrophages mock vs CHIKV-infected DEGs
# GSEA analysis using DOSE database
# need to fetch entrez gene IDs for human homologs
# exclude genes that have multiple human or mouse IDs
gsea_degs <- all_mac_degs %>%
  inner_join(hlogs, by = c(gene = "gene_mm")) %>%
  distinct(gene, gene_hs, entrez_hs, min_fc) %>%
  
  filter(if_all(
    -min_fc,
    ~ !duplicated(.x) & !duplicated(.x, fromLast = TRUE)
  )) %>%

  arrange(desc(min_fc))

gsea_file <- here(dirs$table_dir, "mac_chikv_gsea.qs")

if (!file.exists(gsea_file)) {
  set.seed(42)
  
  gsea_res <- set_names(gsea_degs$min_fc, gsea_degs$entrez_hs)
  
  chikv_gsea <- gsea_res %>%
    gseDO(eps = 1e-100) %>%
    setReadable("org.Hs.eg.db", "ENTREZID")
  
  chikv_gsea %>%
    qsave(gsea_file)
  
} else {
  chikv_gsea <- qread(gsea_file)
}
```

```{r "t cell type markers"}
file_path <- here(dirs$table_dir, "t_type_markers.tsv")

# Fibroblast type markers
# DO NOT FILTER FOR MOCK CELLS
if (!file.exists(file_path)) {
  Idents(so_t) <- so_t$t_type
  
  t_typs <- unique(so_t$t_type)
  
  t_type_markers <- t_typs %>%
    map_dfr(~ {
      so_t %>%
        FindConservedMarkers(
          ident.1 = .x,
          grouping.var = "rep"
        ) %>%
        rownames_to_column("gene") %>%
        mutate(cluster = .x)
    }, .options = furrr_options(seed = TRUE))
  
  # Filter marker genes
  # fold change > 1.25, pct > 0.3
  reps <- unique(so_t$rep)
  
  stat_clmns <- list(
    fc   = str_c(reps, "_avg_log2FC"),
    pct1 = str_c(reps, "_pct.1"),
    pct2 = str_c(reps, "_pct.2")
  )
  
  t_type_markers <- t_type_markers %>%
    filter(
      max_pval < 0.05,
      if_all(all_of(stat_clmns$fc),   ~ .x > log2(1.25)),
      if_all(all_of(stat_clmns$pct1), ~ .x > 0.25),
      if_all(all_of(stat_clmns$pct2), ~ .x < 0.6)
    ) %>%
    arrange(cluster, max_pval)
  
  # GO terms
  # term size > 10, < 400
  expr_gns <- so_t@assays$RNA@counts %>%
    rowSums() %>%
    sort(decreasing = TRUE) %>%
    head(5000)
  
  t_type_go <- t_type_markers %>%
    split(.$cluster) %>%
    map(pull, gene) %>%
    gost(
      organism     = "mmusculus",
      custom_bg    = names(expr_gns),
      domain_scope = "custom",
      evcodes      = TRUE
    ) %>%
    .$result %>%
    dplyr::select(-c(evidence_codes, parents)) %>%
    arrange(query, p_value)
  
  # Save markers
  t_type_markers %>%
    write_tsv(file_path)
  
  t_type_go %>%
    write_tsv(here(dirs$table_dir, "t_type_go.tsv"))
}

# Load marker genes
t_type_markers <- read_tsv(file_path)

t_type_go <- read_tsv(here(dirs$table_dir, "t_type_go.tsv"))

t_type_go <- t_type_go %>%
  separate_rows(intersection, sep = ",") %>%
  nest(intersection = intersection) %>%
  filter(term_size > 10, term_size < 500, intersection_size > 4)
```

```{r "t all DEGs"}
# CHIKV-infected DEGs for all T cells grouped together
Idents(so_t) <- so_t$treatment

chikv_deg_file <- here(dirs$table_dir, "t_all_chikv_degs-1.tsv")

if (!file.exists(chikv_deg_file)) {
  degs <- so_t %>%
    FindConservedMarkers(
      ident.1         = "CHIKV",
      ident.2         = "mock",
      grouping.var    = "rep",
      logfc.threshold = 0.1
    ) %>%
    as_tibble(rownames = "gene")
  
  fc_clmns <- grep("_avg_log2FC$", colnames(t_all_degs), value = TRUE)

  degs <- degs %>%
    rowwise() %>%
    mutate(
      min_fc = min(abs(c(!!!syms(fc_clmns)))),
      min_fc = c(!!!syms(fc_clmns))[abs(c(!!!syms(fc_clmns))) == min_fc]
    ) %>%
    ungroup() %>%
    arrange(desc(min_fc))
  
  degs %>%
    write_tsv(chikv_deg_file)
}

t_all_degs_1 <- read_tsv(chikv_deg_file)

# CHIKV-infected DEGs for all T cells grouped together
# do not use replicates since we have so few T cells
Idents(so_t) <- so_t$treatment

chikv_deg_file <- here(dirs$table_dir, "t_all_chikv_degs-2.tsv")

so_t <- so_t %>%
  mutate_meta(
    mutate,
    cd4_8 = str_extract(t_type, "^CD[48]"),
    cd4_8 = replace_na(cd4_8, "other")
  )

if (!file.exists(chikv_deg_file)) {
  degs <- c("CD4", "CD8") %>%
    map_dfr(~ {
      so_t %>%
        subset(cd4_8 == .x) %>%
        FindMarkers(
          ident.1         = "CHIKV",
          ident.2         = "mock",
          logfc.threshold = 0.25
        ) %>%
        as_tibble(rownames = "gene") %>%
        mutate(cd4_8 = .x)
    })
  
  degs %>%
    write_tsv(chikv_deg_file)
}

t_all_degs_2 <- read_tsv(chikv_deg_file)
```

```{r "t subset DEGs"}
# CHIKV-infected DEGs for each subset
Idents(so_t) <- so_t$treatment

chikv_deg_file <- here(dirs$table_dir, "t_type_chikv_degs.tsv")

if (!file.exists(chikv_deg_file)) {
  typs <- unique(so_t$t_type)
  
  degs <- typs %>%
    map_dfr(~ {
      so_t %>%
        subset(t_type == .x) %>%
        FindMarkers(
          ident.1         = "CHIKV",
          ident.2         = "mock",
          logfc.threshold = 0.25
        ) %>%
        as_tibble(rownames = "gene") %>%
        mutate(t_type = .x)
    })
  
  degs %>%
    write_tsv(chikv_deg_file)
}

t_typ_degs <- read_tsv(chikv_deg_file)
```

## Macrophages

### Subset annotations {.tabset .tabset-pills}

UMAP projections show macrophage subsets

```{r "fig 4A", fig.width = 11.25, fig.height = 5.6}
# Create mac subset UMAPs
create_subset_umap <- function(so_in, sub_clmn, clrs) {
  
  sub_labs <- get_nlab_fun(so_in, sub_clmn, l = " (", r = ")")
  
  res <- so_in %>%
    plot_scatter(
      sub_clmn,
      x = "hUMAP_1",
      y = "hUMAP_2",
      plot_lvls = names(clrs),
      size = 0.7
    ) +
    scale_color_manual(values = clrs, labels = sub_labs) +
    guides(color = guide_legend(
      ncol = 1, override.aes = list(size = 3), reverse = TRUE)
    ) +
    int_u_theme +
    theme(
      plot.title  = element_text(hjust = 0.5, size = 20),
      legend.text = element_text(size = 14)
    )
  
  res
}

# # Adjust mac_type labels
# so_mac <- so_mac %>%
#   mutate_meta(
#     mutate,
#     mac_type = replace_na(mac_type, "unassigned"),
#     mac_type = recode(mac_type, !!!mac_typ_labs)
#   )

# Create mac subset UMAPs
u <- treats %>%
  map(~ {
    so_mac %>%
      subset(treatment == .x) %>%
      create_subset_umap("mac_type", mac_typ_cols_2) +
      ggtitle(.x)
  })

# Create mac subset bargraphs
br <- so_mac@meta.data %>%
  mutate(
    treatment = fct_relevel(treatment, treats),
    rep = str_c("r", rep)
  ) %>%
  ggplot(aes(rep, fill = mac_type)) +
  geom_bar(position = "fill") +
  facet_wrap(~ treatment, scales = "free") +
  scale_fill_manual(values = mac_typ_cols_2) +
  scale_y_continuous(expand = expansion(0)) +
  scale_x_discrete(labels = (function(x) str_remove(x, str_c("-", params$tm)))) +
  base_theme +
  theme(
    aspect.ratio    = 3,
    legend.position = "none",
    strip.text      = element_text(size = 20),
    axis.title      = element_blank(),
    axis.text.y     = element_blank(),
    axis.line.x     = element_blank(),
    axis.line.y     = element_blank(),
    axis.ticks.x    = element_blank(),
    axis.ticks.y    = element_blank()
  )

# Create final figure
plot_grid(
  plotlist = append(u, list(br)),
  nrow  = 1,
  align = "vh",
  axis  = "trbl",
  rel_widths = c(1, 1, 0.7)
)

# Boxplots showing module score for assigned subsets
# so_mac@meta.data %>%
#   pivot_longer(all_of(feat_lvls)) %>%
#   ggplot(aes(mac_type, value, fill = mac_type)) +
#   geom_boxplot() +
#   facet_wrap(~ name, scales = "free_y") +
#   scale_fill_manual(values = mac_typ_cols) +
#   base_theme +
#   theme(
#     axis.text.x     = element_text(angle = 45, hjust = 1),
#     axis.title      = element_blank(),
#     legend.position = "none"
#   )

```

<br>

Heatmaps show mean expression of gene lists described
by Culemann et al. Replicates are shown separately for each macrophage
subset.

```{r "culemann heatmaps", results = "asis", fig.height = 10, fig.width = 8}
# Format culemann gene lists
# Cx3cr1 is tagged with TdTomato
var_feats <- VariableFeatures(so_mac)
var_feats <- rownames(so_mac)

feats <- culemann_genes %>%
  imap(~ {
    fts <- .x %>%
      dplyr::select(gene, cluster) %>%
      split(.$cluster) %>%
      map(pull, gene)
    
    fts <- fts[names(fts) %in% feat_key[[.y]]]
    fts <- fts[feat_key[[.y]]]
    
    fts %>%
      map(~ {
        .x[.x == "TdTomato"] <- "Cx3cr1"
        .x[.x %in% var_feats]
      })
  }) %>%
  flatten()

# Culemann heatmap data
all_gns <- feats %>%
  purrr::reduce(c) %>%
  unique()

plt_dat <- so_mac %>%
  FetchData(c("treatment", "rep", "mac_type", all_gns)) %>%
  as_tibble(rownames = ".cell_id") %>%
  pivot_longer(any_of(all_gns)) %>%
  
  group_by(treatment, rep, mac_type, name) %>%
  summarize(value = mean(value), .groups = "drop") %>%
  
  group_by(name, treatment) %>%
  mutate(value = as.numeric(scale(value))) %>%
  ungroup() %>%
  mutate(
    treatment = fct_relevel(treatment, treats),
    mac_type  = fct_relevel(mac_type, names(mac_typ_cols))
  )

# Set list names
rev(feats) %>%
  iwalk(~ {
    ttl <- .y
    gns <- .x
    
    cat("\n\n####", ttl, "\n\n")
    
    # Filter for genes in gene list
    dat <- plt_dat %>%
      filter(name %in% gns)
    
    # Set cell type to use for sorting genes
    # use infiltrating for both infiltrating gene lists
    typ <- str_remove(ttl, ".+_(?=infiltrating)")
    
    # Sort genes based on fold change compared to other cell types
    lvls <- dat %>%
      group_by(treatment, name, rep) %>%
      mutate(
        value = value + abs(min(value)),
        fc = value[mac_type == typ] / mean(value[mac_type != typ])
      ) %>%
      group_by(name) %>%
      summarize(fc = mean(fc), .groups = "drop") %>%
      arrange(desc(fc)) %>%
      pull(name)
    
    # Set aspect ratio based on number of genes plotted
    asp_rat <- length(lvls) / n_distinct(dat$rep)
    
    # Function to shorten strip labels
    lab_fn <- function(x) {
      re  <- "RELMa|AQP1|lining|infiltrating"
      idx <- grepl(re, x)
      
      x[idx] <- str_extract(x[idx], re)
      
      # if (grepl(re, x)) x <- str_extract(x, re)        
      
      x
    }
    
    # Create heatmaps
    plt <- dat %>%
      filter(name %in% lvls) %>%
      mutate(name = fct_relevel(name, rev(lvls))) %>%
      
      split(.$treatment) %>%
      imap(~ {
        plt <- .x %>%
          ggplot(aes(rep, name, fill = value)) +
          geom_tile() +
          facet_wrap(
            ~ mac_type,
            labeller = as_labeller(lab_fn),
            nrow = 1
          ) +
          scale_fill_gradientn(colours = c("lightblue", "white", "red")) +
          # scale_fill_gradientn(colours = c("blue", "white", "red")) +
          ggtitle(.y) +
          guides(
            fill = guide_colorbar(
              ticks = FALSE,
              barwidth = unit(10, "pt"),
              barheight = unit(150, "pt")
            )
          ) +
          base_theme +
          theme(
            aspect.ratio = asp_rat,
            plot.title   = element_text(hjust = 0.5),
            panel.border = element_rect(colour = ln_col, size = ln_pt),
            legend.title = element_blank(),
            strip.text   = element_text(size = 10),
            # strip.clip   = "off",
            axis.line.x  = element_blank(),
            axis.line.y  = element_blank(),
            axis.ticks.x = element_blank(),
            axis.title   = element_blank(),
            axis.text.x  = element_blank()
          )
        
        if (length(gns) > 50) {
          plt <- plt +
            theme(
              aspect.ratio = 10,
              axis.text.y  = element_blank(),
              axis.ticks.y = element_blank()
            )
        }
        
        plt
      }) %>%
      plot_grid(
        plotlist = .,
        nrow     = 1,
        align    = "h",
        axis     = "tb"
      )
    
    print(plt)
    cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
```

<br>

### CHIKV+ cells

```{r "WIP CHIKV+", eval = FALSE}
# UMAPs
so_mac %>%
  plot_scatter(
    "chikv_grp",
    "hUMAP_1", 
    "hUMAP_2",
    group_col = "treatment",
    size = 2,
    top = "CHIKV-high"
  )

so_mac %>%
  plot_scatter(
    "Il1b",
    "hUMAP_1",
    "hUMAP_2",
    group_col = "treatment",
    size = 2
  )

so_mac %>%
  plot_violin(
    "pct_mito",
    cluster_col = "chikv_grp",
    group_col = "mac_type",
    method = "boxplot"
  )

# DEGs CHIKV-high
degs <- unique(so_mac$mac_type) %>%
  map_dfr(~ {
    so_mac %>%
      subset(
        treatment == "CHIKV" &
          mac_type == .x
      ) %>%
      wilcoxauc(group_by = "chikv_grp", seurat_assay = "RNA") %>%
      mutate(cell_type = .x)
  })

degs <- so_mac %>%
  subset(
    treatment == "CHIKV"
    # mac_type == "infiltrating"
  ) %>%
  wilcoxauc(group_by = "chikv_grp", seurat_assay = "RNA")

gns <- degs %>%
  filter(
    group == "CHIKV-high",
    padj < 0.05,
    logFC > 0
    # pct_in > 25,
    # cell_type == "infiltrating"
    # cell_type != "unassigned"
  ) %>%
  arrange(desc(logFC)) %>%
  mutate(n_cells = 78 * (pct_in / 100)) %>%
  filter(n_cells >= 10) %>%
  pull(feature)

go <- gns %>%
  gost(organism = "mmusculus", evcodes = TRUE)

# Plot DEGs
gns[1:10] %>%
  map(~ {
    so_mac %>%
      # mutate_meta(
      #   mutate,
      #   chikv_grp = case_when(
      #     mac_type == "infiltrating" & chikv_grp == "CHIKV-high" ~ chikv_grp,
      #     chikv_grp == "CHIKV-high" ~ "other CHIKV-high",
      #     mac_type == "infiltrating" ~ mac_type,
      #     TRUE ~ chikv_grp
      #   )
      # ) %>%
      plot_violin(
        .x,
        cluster_col = "chikv_grp",
        group_col = "mac_type",
        method = "boxplot",
        # plot_lvls = c("CHIKV-high", "other CHIKV-high", "infiltrating", "CHIKV-low")
        panel_nrow = 1
      ) +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  }) %>%
  plot_grid(plotlist = .)

# Chi-square
# old_mac <- qread(here(dirs$so_dir, "2023-12-27/so_mac.qs"))
old_mac <- qread(here(dirs$so_dir, "original_objects/so_int.qs"))

dat <- old_mac@meta.data %>%
# dat <- so_mac@meta.data %>%
  filter(treatment == "CHIKV")
  # select(mac_type, chikv_grp)

# Calculate the necessary values
typ <- "CX3CR1_lining"
typ <- "infiltrating"
typ <- "unassigned"
typ <- "RELMa_interstitial"
typ <- "AQP1_interstitial"

unique(dat$mac_type) %>%
  map_dfr(~ {
    N <- nrow(dat) # Total number of cells
    K <- sum(dat$chikv_grp == "CHIKV-high") # Total number of CHIKV-high cells
    n <- sum(dat$mac_type == .x) # Number of cells in infiltrating
    x <- sum(dat$mac_type == .x & dat$chikv_grp == "CHIKV-high") # Ag-competent in CHIKV
    
    # Perform the hypergeometric test
    tibble(
      mac_type = .x,
      p        = phyper(x, K, N - K, n, lower.tail = FALSE)
    )
  }) %>%
  mutate(padj = p.adjust(p, method = "bonferroni"))

# dat %>%
#   write_tsv("chikv_high_macs.tsv.gz")
```

<br>

### Differential expression {.tabset .tabset-pills}

Heatmap shows top upregulated genes associated with inflammatory disease for
CHIKV vs mock-infected macrophages

```{r, fig.width = 2.5, fig.height = 6, out.width = "30%"}
# GSEA genes associated with bone disease
terms_re <- c("connective", "musculoskeletal", "arthritis", "bone") %>%
  str_c(collapse = "|")

gsea_gns <- chikv_gsea@result %>%
  dplyr::filter(
    grepl(terms_re, Description),
    !grepl("cancer|ischemic", Description)
  ) %>%
  pull(core_enrichment) %>%
  map(str_split, "/") %>%
  unlist() %>%
  unique()

gsea_gns <- hlogs %>%
  dplyr::filter(gene_hs %in% gsea_gns & !is.na(gene_mm)) %>%
  pull(gene_mm) %>%
  unique()

# Genes to plot
# plot top 60 genes
top_gsea_gns <- all_mac_degs %>%
  dplyr::filter(
    max_pval < 0.05,
    min_fc   > 0.2,
    gene %in% gsea_gns
  ) %>%
  arrange(desc(min_fc)) %>%
  pull(gene) %>%
  head(60) %>%
  unique()

# Format data
DefaultAssay(so_mac) <- "RNA"

dat <- so_mac %>%
  FetchData(c("orig.ident", "treatment", "rep", "sample", top_gsea_gns)) %>%
  pivot_longer(all_of(top_gsea_gns)) %>%
  group_by(rep, treatment, name) %>%
  summarize(value = mean(value), .groups = "drop") %>%
  group_by(name) %>%
  mutate(value = scale(value)) %>%
  ungroup() %>%
  mutate(
    name = fct_relevel(name, rev(top_gsea_gns)),
    treatment = fct_relevel(treatment, treats)
  )
  
# Create heatmap
dat %>%
  ggplot(aes(rep, name, fill = value)) +
  geom_tile(color = ln_col) +
  scale_fill_gradientn(colours = c("white", "#0072B2")) +
  guides(fill = guide_colorbar(ticks = FALSE)) +
  facet_wrap(~ treatment) +
  djvdj_theme() +
  theme(
    strip.clip   = "off",
    strip.text   = element_text(size = 8.5),
    panel.border = element_blank(),
    axis.ticks   = element_blank(),
    legend.key.width = unit(10, "pt"),
    legend.key.height = unit(30, "pt"),
    axis.title   = element_blank(),
    legend.title = element_blank(),
    axis.text.y  = element_text(size = 8.5)
  )
```

<br>

UMAP projections show examples of upregulated genes for mock vs CHIKV-infected
macrophages

```{r, fig.width = 10, fig.height = 6.5}
# gns <- c("Nlrp3", "Tlr2", "Mdm2", "Plau", "Slamf7")
gns <- head(top_gsea_gns, 4)

u_clrs    <- grp_cols
u_clrs[1] <- lighten("#009E73", 0.2)

names(u_clrs) <- treats

gn_boxes <- gns %>%
  map(~ {
    d <- so_mac %>%
      FetchData(c("hUMAP_1", "hUMAP_2", "rep", "treatment", .x)) %>%
      mutate(treatment = fct_relevel(treatment, treats))
    
    u <- d %>%
      plot_scatter(
        .x,
        "hUMAP_1", "hUMAP_2",
        plot_colors = c("#56B4E9", "white", "#6A51A3"),
        n_label = "none",
        size    = 0.7
      ) +
      guides(color = guide_colorbar(title.position = "top", barheight = unit(6, "pt"), barwidth = unit(100, "pt"), ticks = FALSE)) +
      umap_theme +
      theme(
        legend.position = "top",
        legend.justification = "center",
        legend.title = element_text(size = 20)
      )
    
    bx <- d %>%
      ggplot(aes(rep, !!sym(.x), fill = treatment)) +
      geom_boxplot(outlier.size = 0.25) +
      scale_fill_manual(values = u_clrs) +
      facet_wrap(~ treatment) +
      djvdj_theme() +
      theme(
        legend.position = "none",
        panel.border    = element_blank(),
        axis.line.y     = element_line(color = "grey85", size = 0.5),
        axis.title      = element_blank(),
        axis.text.x     = element_blank(),
        axis.ticks.x    = element_blank()
      )
    
    plot_grid(
      u, bx,
      align = "vh",
      axis  = "trbl",
      nrow = 1,
      rel_widths = c(1, 0.82)
    )
  })

plot_grid(
  plotlist = gn_boxes,
  align = "vh",
  axis  = "trbl",
  ncol  = 2
)



# gns <- gsea_res@result %>%
#   dplyr::filter(Description == "arthritis") %>%
#   pull(core_enrichment)
# 
# gns <- gns %>%
#   str_split("/") %>%
#   flatten() %>%
#   as.character()
# 
# gns <- hlogs %>%
#   dplyr::filter(gene %in% gns) %>%
#   pull(gene_mm)

# gns[1:16] %>%
#   map(~ {
#     if (!.x %in% rownames(x@assays$RNA)) return(NULL)
#     
#     so_mac %>%
#       FetchData(c(.x, "UMAP_1", "UMAP_2", "treatment", "chikv_clst_grp")) %>%
#       arrange(!!sym(.x)) %>%
#       ggplot(aes(UMAP_1, UMAP_2, color = !!sym(.x))) +
#       geom_point(size = 0.25) +
#       scale_color_gradientn(colours = c("blue", "white", "red")) +
#       umap_theme
#   }) %>%
#   plot_grid(
#     plotlist = .,
#     align = "vh",
#     axis  = "trbl"
#   )
```

<br>

Top genes upregulated in CHIKV-infected mice are shown below for each
macrophage subset.

```{r "DEG upset plot", fig.width = 10, fig.height = 4}
degs_upset <- mac_degs %>%
  split(.$direction) %>%
  imap(~ {
    .x %>%
      group_by(cell_type) %>%
      mutate(cell_type = str_c(cell_type, " (", label_comma()(n()), ")")) %>%
      group_by(gene) %>%
      summarize(cell_type = list(cell_type), .groups = "drop") %>%
      ggplot(aes(cell_type)) +
      geom_bar(fill = "#009E73") +
      geom_text(stat = "count", aes(label = after_stat(count)), vjust = -1, size = 8 / .pt, alpha = 1) +
      labs(title = .y, y = "number of genes") +
      scale_x_upset(n_intersections = 14) +
      scale_y_continuous(expand = expansion(c(0, 0.2))) +
      theme(
        aspect.ratio     = 0.5,
        panel.background = element_rect(fill = NA, colour = ln_col, linewidth = ln_pt),
        panel.grid       = element_blank(),
        axis.ticks.x     = element_blank(),
        axis.title.x     = element_blank()
      )
  }) %>%
  plot_grid(
    plotlist = .,
    nrow  = 1,
    align = "h",
    axis  = "tb"
  )

degs_upset
```

```{r "DEG heatmaps", fig.width = 6, fig.height = 10, results = "asis", out.width = "50%"}
# Plot top 60 DEGs
n_gns <- 60

heats <- mac_degs %>%
  split(.$cell_type) %>%
  imap(~ {
    .x %>%
      split(.$direction) %>%
      imap(~ {
        gns <- .x$gene %>%
          head(n_gns)
        
        dat <- so_mac %>%
          FetchData(c("treatment", "rep", gns)) %>%
          pivot_longer(all_of(gns)) %>%
          
          group_by(name, treatment, rep) %>%
          summarize(value = mean(value), .groups = "drop") %>%
          group_by(name) %>%
          mutate(value = as.numeric(scale(value))) %>%
          ungroup() %>%
          mutate(name = fct_relevel(name, rev(gns)))
        
        asp_rat <- min(10, length(gns) / n_distinct(so_mac$rep))
        
        dat %>%
          ggplot(aes(rep, name, fill = value)) +
          geom_tile() +
          facet_wrap(~ treatment, nrow = 1) +
          scale_fill_gradientn(colours = c("lightblue", "white", "#D7301F")) +
          ggtitle(.y) +
          guides(fill = guide_colorbar(
            ticks = FALSE,
            barwidth = unit(100, "pt"), 
            barheight = unit(7, "pt")
          )) +
          base_theme +
          theme(
            aspect.ratio    = asp_rat,
            plot.title      = element_text(hjust = 0.5),
            legend.position = "bottom",
            legend.justification = "center",
            legend.title    = element_blank(),
            axis.title      = element_blank()
          )
      }) %>%
      plot_grid(
        plotlist = .,
        nrow  = 1,
        align = "h",
        axis  = "tb"
      )
  })

# Print plots
heats %>%
  iwalk(~ {
    cat("\n\n####", .y, "\n\n")
    
    print(.x)
    
    cat("\n\n<br>\n\n")
    # cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
```

### Simmons et al. {.tabset .tabset-pills}

```{r "simmons module scores", fig.width = 10, fig.height = 10, results = "asis"}
# Add module scores to object
mods <- simmons_genes %>%
  map(~ unique(.x$gene_mm))

nms <- names(mods)
nms <- set_names(str_c(nms, seq_along(mods)), nms)

# Original macrophage object
so_mac@active.assay <- "RNA"

so_mac <- so_mac %>%
  mutate_meta(dplyr::select, -any_of(names(nms))) %>%
  AddModuleScore(features = mods, name = names(mods)) %>%
  mutate_meta(~ {
    .x %>%
      rename(!!!nms) %>%
      mutate(treatment = fct_relevel(treatment, treats))
  })

# Plot module scores
mod_plts <- names(mods) %>%
  set_names() %>%
  map(~ {
    txt_theme <- theme(
      plot.title = element_text(size = 24),
      strip.text = element_text(size = 18),
    )
    
    # UMAP projections
    u <- so_mac %>%
      plot_scatter(
        .x,
        "hUMAP_1", "hUMAP_2",
        # x = "UMAP_1", y = "UMAP_2",
        group_col    = "treatment",
        outline      = TRUE,
        plot_colors  = c("#56B4E9", "white", "#D7301F"),
        label_params = list(size = 16)
      ) +
      guides(fill = guide_colorbar(
        ticks = FALSE,
        barheight = unit(150, "pt"),
        barwidth = unit(12, "pt"),
        frame.colour = ln_col
      )) +
      labs(title = str_c(.x, " module")) +
      umap_theme +
      txt_theme +
      theme(
        aspect.ratio     = NULL,
        panel.background = element_rect(color = ln_col),
        plot.margin      = margin(50, 5, 5, 5, unit = "pt"),
        plot.title       = element_text(hjust = 0.5, size = 24),
        strip.text       = element_text(size = 18),
        legend.title     = element_blank()
      )
    
    # Histograms
    treat_clrs <- c(
      mock = "#56B4E9", CHIKV = "#D7301F"
    )
    
    h <- so_mac@meta.data %>%
      mutate(treatment = fct_relevel(treatment, rev(treats))) %>%
      ggplot(aes(!!sym(.x), fill = treatment)) +
      geom_histogram(position = "identity", alpha = 0.7, bins = 30) +
      scale_fill_manual(values = treat_clrs) +
      labs(y = "number of cells") +
      base_theme +
      theme(
        legend.position      = "bottom",
        legend.justification = 0.5,
        legend.title         = element_blank(),
        legend.text          = element_text(size = 14),
        axis.title.x         = element_blank(),
        axis.title.y         = element_text(size = 14)
      )
    
    # Boxplots
    b <- so_mac@meta.data %>%
      ggplot(aes(mac_type, !!sym(.x), fill = mac_type, alpha = treatment)) +
      # geom_violin(draw_quantiles = c(0.25, 0.75), scale = "width", position = position_dodge(width = 1.01)) +
      # stat_summary(
      #   geom = "point", fun = median,
      #   position = position_dodge2(width = 1), show.legend = FALSE
      # ) +
      geom_boxplot(outlier.size = 0.1, key_glyph = draw_key_point, notch = TRUE) +
      scale_fill_manual(values = mac_typ_cols) +
      scale_alpha_manual(values = c(0.25, 0.9)) +
      guides(
        fill = "none",
        alpha = guide_legend(override.aes = list(shape = 22, size = 4, fill = "black"))
      ) +
      base_theme +
      theme(
        legend.position      = "bottom",
        legend.justification = 0.5,
        legend.title         = element_blank(),
        legend.text          = element_text(size = 14),
        axis.title.x         = element_blank(),
        axis.title.y         = element_text(size = 14),
        axis.text.x          = element_text(angle = 45, hjust = 1)
      )
    
    # Create final figure
    u / (h + b) +
      plot_layout(heights = c(1, 0.4))
  })

mod_plts %>%
  iwalk(~ {
    cat("\n\n####", .y, "\n\n")
    
    print(.x)
    
    cat("\n\n---\n\n<br>\n\n<br>\n\n")
  })
```

## T cells

Genes upregulated in T cells from CHIKV vs mock-infected mice are shown below.
All CD4+ or CD8+ T cells were grouped together.

```{r "upreg T cells", fig.width = 8, fig.height = 10, out.width = "30%"}
# Select genes to plot
gns <- t_all_degs_2 %>%
  filter(
    avg_log2FC > 0.25, p_val_adj < 0.05,
    pct.1 > 0.3, pct.2 < 0.8,
    !grepl("^mt-", gene)
  ) %>%
  arrange(p_val_adj)

gns_key <- gns %>%
  split(.$cd4_8) %>%
  map(pull, gene)

gns <- unique(gns$gene)

# Format data for plotting
plt_dat <- so_t %>%
  FetchData(c("treatment", "rep", "cd4_8", gns)) %>%
  as_tibble(rownames = ".cell_id") %>%
  pivot_longer(all_of(gns)) %>%
  
  group_by(treatment, rep, cd4_8, name) %>%
  summarize(value = mean(value), .groups = "drop") %>%
  
  group_by(name, cd4_8) %>%
  mutate(value = as.numeric(scale(value))) %>%
  ungroup() %>%
  
  rowwise() %>%
  filter(name %in% gns_key[[cd4_8]]) %>%
  ungroup() %>%
  mutate(
    treatment = fct_relevel(treatment, treats),
    name = fct_relevel(name, gns)
  )

# Create heatmaps
t_heats <- plt_dat %>%
  split(.$cd4_8) %>%
  imap(~ {
    asp_rat <- n_distinct(.x$name) / n_distinct(.x$rep)
    
    .x %>%
      ggplot(aes(rep, name, fill = value)) +
      geom_tile() +
      facet_wrap(~ treatment, nrow = 1) +
      scale_fill_gradientn(colours = c("lightblue", "white", "red")) +
      guides(fill = guide_colorbar(ticks = FALSE, barwidth = unit(10, "pt"), barheight = unit(150, "pt"))) +
      ggtitle(str_c(.y, "+ T cells")) +
      base_theme +
      theme(
        aspect.ratio = asp_rat,
        plot.title = element_text(hjust = 0.5),
        strip.clip = "off",
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  })

plot_grid(
  plotlist = t_heats,
  nrow = 1,
  rel_widths = c(1, 0.7)
)
```

```{r "upreg all T cells", fig.width = 8, fig.height = 10, eval = FALSE}

# Select genes to plot
gns <- t_all_degs %>%
  filter(
    min_FC > log2(1.25), minimump_p_val < 0.05,
    !grepl("^mt-", gene)
  ) %>%
  arrange(desc(min_FC))

gns_key <- gns %>%
  split(.$cd4_8) %>%
  map(pull, gene)

gns <- unique(gns$gene)

# Format data for plotting
plt_dat <- so_t %>%
  FetchData(c("treatment", "rep", "cd4_8", gns)) %>%
  as_tibble(rownames = ".cell_id") %>%
  pivot_longer(all_of(gns)) %>%
  
  group_by(treatment, rep, cd4_8, name) %>%
  summarize(value = mean(value), .groups = "drop") %>%
  
  group_by(name, cd4_8) %>%
  mutate(value = as.numeric(scale(value))) %>%
  ungroup() %>%
  
  rowwise() %>%
  filter(name %in% gns_key[[cd4_8]]) %>%
  ungroup() %>%
  mutate(
    treatment = fct_relevel(treatment, treats),
    name = fct_relevel(name, gns)
  )

# Create heatmaps
t_heats <- c("CD4", "CD8") %>%
  set_names() %>%
  map(~ {
    dat <- plt_dat %>%
      filter(cd4_8 == .x)
    
    asp_rat <- n_distinct(dat$name) / n_distinct(dat$rep)
    
    dat %>%
      ggplot(aes(rep, name, fill = value)) +
      geom_tile() +
      facet_wrap(~ treatment, nrow = 1) +
      scale_fill_gradientn(colours = c("lightblue", "white", "red")) +
      guides(fill = guide_colorbar(ticks = FALSE, barwidth = unit(10, "pt"), barheight = unit(150, "pt"))) +
      ggtitle(str_c(.x, "+ T cells")) +
      base_theme +
      theme(
        aspect.ratio = asp_rat,
        plot.title = element_text(hjust = 0.5),
        strip.clip = "off",
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  })

plot_grid(
  plotlist = t_heats,
  nrow = 1,
  rel_widths = c(1, 0.7)
)

```

```{r "upreg T cell subsets", fig.width = 8, fig.height = 10, eval = FALSE}

# Select genes to plot
gns <- t_typ_degs %>%
  filter(
    avg_log2FC > 0.25, p_val_adj < 0.05,
    pct.1 > 0.3, pct.2 < 0.8,
    !grepl("^mt-", gene)
  ) %>%
  arrange(p_val_adj)

gns_key <- gns %>%
  split(.$t_type) %>%
  map(pull, gene)

gns <- unique(gns$gene)

# Format data for plotting
plt_dat <- so_t %>%
  FetchData(c("treatment", "rep", "t_type", gns)) %>%
  as_tibble(rownames = ".cell_id") %>%
  pivot_longer(all_of(gns)) %>%
  
  group_by(treatment, rep, t_type, name) %>%
  summarize(value = mean(value), .groups = "drop") %>%
  
  group_by(name, t_type) %>%
  mutate(value = as.numeric(scale(value))) %>%
  ungroup() %>%
  
  rowwise() %>%
  filter(name %in% gns_key[[t_type]]) %>%
  ungroup() %>%
  mutate(
    treatment = fct_relevel(treatment, treats),
    name = fct_relevel(name, gns)
  )

# Create heatmaps
typs <- unique(so_t$t_type)

t_heats <- typs %>%
  set_names() %>%
  map(~ {
    dat <- plt_dat %>%
      filter(t_type == .x)
    
    if (nrow(dat) == 0) return(NULL)
    
    asp_rat <- n_distinct(dat$name) / n_distinct(dat$rep)
    
    dat %>%
      ggplot(aes(rep, name, fill = value)) +
      geom_tile() +
      facet_wrap(~ treatment, nrow = 1) +
      scale_fill_gradientn(colours = c("lightblue", "white", "red")) +
      guides(fill = guide_colorbar(ticks = FALSE, barwidth = unit(10, "pt"), barheight = unit(150, "pt"))) +
      ggtitle(str_c(.x, "+ T cells")) +
      base_theme +
      theme(
        aspect.ratio = asp_rat,
        plot.title = element_text(hjust = 0.5),
        strip.clip = "off",
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  }) %>%
  purrr::discard(is.null)

plot_grid(
  plotlist = t_heats,
  nrow = 1,
  rel_widths = c(1, 0.7)
)

```

```{r "downreg T cells", fig.width = 8, fig.height = 10, eval = FALSE}
# Select genes to plot
gns <- t_all_degs_2 %>%
  filter(
    avg_log2FC < -0.25, p_val_adj < 0.05,
    pct.1 < 0.8, pct.2 > 0.3,
    !grepl("^mt-", gene)
  ) %>%
  arrange(p_val_adj)

gns_key <- gns %>%
  split(.$cd4_8) %>%
  map(pull, gene)

gns <- unique(gns$gene)

# Format data for plotting
plt_dat <- so_t %>%
  FetchData(c("treatment", "rep", "cd4_8", gns)) %>%
  as_tibble(rownames = ".cell_id") %>%
  pivot_longer(all_of(gns)) %>%
  
  group_by(treatment, rep, cd4_8, name) %>%
  summarize(value = mean(value), .groups = "drop") %>%
  
  group_by(name, cd4_8) %>%
  mutate(value = as.numeric(scale(value))) %>%
  ungroup() %>%
  
  rowwise() %>%
  filter(name %in% gns_key[[cd4_8]]) %>%
  ungroup() %>%
  mutate(
    treatment = fct_relevel(treatment, treats),
    name = fct_relevel(name, gns)
  )

# Create heatmaps
t_heats <- c("CD4", "CD8") %>%
  set_names() %>%
  map(~ {
    dat <- plt_dat %>%
      filter(cd4_8 == .x)
    
    asp_rat <- n_distinct(dat$name) / n_distinct(dat$rep)
    
    dat %>%
      ggplot(aes(rep, name, fill = value)) +
      geom_tile() +
      facet_wrap(~ treatment, nrow = 1) +
      scale_fill_gradientn(colours = c("lightblue", "white", "red")) +
      guides(fill = guide_colorbar(ticks = FALSE, barwidth = unit(10, "pt"), barheight = unit(150, "pt"))) +
      ggtitle(str_c(.x, "+ T cells")) +
      base_theme +
      theme(
        aspect.ratio = asp_rat,
        plot.title = element_text(hjust = 0.5),
        strip.clip = "off",
        axis.title = element_blank(),
        legend.title = element_blank()
      )
  })

plot_grid(
  plotlist = t_heats,
  nrow = 1,
  rel_widths = c(1, 0.7)
)
```

<br>

Ifng expression is shown below for each T cell subset

```{r "Ifng expression", fig.width = 7, fig.height = 6}
dat <- so_t %>%
  mutate_meta(
    mutate,
    treatment = fct_relevel(treatment, treats)
  )

u <- dat %>%
  plot_scatter(
    "Ifng",
    "hUMAP_1", "hUMAP_2",
    group_col = "treatment",
    size = 1,
    outline = TRUE,
    plot_colors = c("white", "#035B8F")
  ) +
  guides(fill = guide_colorbar(
    ticks = FALSE,
    barwidth  = unit(7, "pt"),
    barheight = unit(100, "pt")
  )) +
  umap_theme +
  theme(
    panel.border = element_rect(colour = ln_col, linewidth = ln_pt)
  )

bx <- dat %>%
  plot_violin(
    "Ifng",
    "t_type",
    "treatment",
    method        = "boxplot",
    plot_colors   = ito_cols,
    outlier.size  = 0.5,
    outlier.alpha = 1,
    width         = 0.6
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

plot_grid(
  u, bx,
  ncol  = 1,
  align = "v",
  axis  = "rl",
  rel_heights = c(1, 0.5)
)
```
